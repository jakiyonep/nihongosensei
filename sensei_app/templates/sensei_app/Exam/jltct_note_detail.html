{% extends 'sensei_app/base.html' %}
{% load static %}
{% load markdownx %}
{% load markdownify %}
{% block title %}{{note.title}}{% endblock %}
{% block content %}


<head>
	<link rel="stylesheet" href="{% static 'sensei_app/css/jltct.min.css' %}">
	<link rel="stylesheet" href="{% static 'sensei_app/css/common.min.css' %}">
</head>
<body>
  {% include 'sensei_app/navbar.html' %}
  <div class="wrapper jltct_wrapper">
		<section class="left_column">
      <div class="note_info">
        <h1 class="note_title">{{note.title}}</h1>
        <div class="meta_info">
          <div class="info_time">
						<i class="far fa-clock"></i><span class="meta_info_update">{{note.update}}</span>
						<div class="like_container info_like">
							{% include "sensei_app/Exam/like.html" %}
						</div>
					</div>
					<div class="info_section">
          	<i class="fas fa-circle {{ note.section.section_slug }}"></i><span class="meta_info_section">{{note.section}}</span><br>
					</div>
          <div class="meta_info_tags">
            {% for tag in note.tag.all %}
              <a href="{% url 'sensei_app:tag_notes' tag.tag_slug %}">{{tag}}</a>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="content">
        {{ note.content|markdown_to_html}}
      </div>
			{% if note.jltctreference_set.all %}
				<div class="reference sub">
					<p class="sub_head">参考</p>
					{% for reference in note.jltctreference_set.all %}
							<li>
								<a href="{{reference.url}}">{{reference.name}}</a>
							</li>
					{% endfor %}
				</div>
			{% endif %}
			{% if note.related_note.all %}
				<div class="related sub">
					<p class="sub_head">関連ノート</p>
					{% for related in note.related_note.all %}
						<li>
							<a href="{% url 'sensei_app:note_detail' related.title_slug %}">{{related.title}}</a>
						</li>
					{% endfor %}
				</div>
			{% endif %}
			<div class="note_comment_section">
				{% include "sensei_app/Exam/comment_section.html" %}
			</div>
		</section>
		<section class="right_column jltct_detail_right_column">
			{% include 'sensei_app/Exam/right_column.html' %}
		</section>
  </div>

<!--note_like -->
<script type="text/javascript">
		$(document).on('click', '.note_like_button',function(event){
			event.preventDefault();
    		var note_id = $(this).attr('name')
    		$.ajax({
    			 type: "POST",
    			 url: "{% url 'sensei_app:note_like' %}",
    			 data: {
    				'note_id': note_id,
    				'csrfmiddlewaretoken': '{{ csrf_token }}',
    		 },
    			 dataType: "json",
    			 success: function(response) {
    				 console.log('okay')
    					$('.like_container').html(response['form'])
    				},
    		});
	  	})
</script>

<!--note_comment_submit -->
<script type="text/javascript">
	$(document).on('click', '.note_comment_submit_button',function(event){
		event.preventDefault();
    var checked = confirm("投稿してもよろしいでしょうか？")
    if (checked == true){
  		var comment_content = $('#comment_content').val()
			var note_id = $('.note_comment_form').attr('id')
  		$('.comment_add_container').slideToggle()
  		$.ajax({
  			 type: "POST",
  			 url: "{% url 'sensei_app:jltct_comment_add' %}",
  			 data: {
  				'comment_content': comment_content,
					'note_id': note_id,
  				'csrfmiddlewaretoken': '{{ csrf_token }}',
  		 },
  			 dataType: "json",
  			 success: function(response) {
  					$('.note_comments').html(response['form'])
  					$('#comment_content').val('')
  			},
  		});
    } else{
      return false
    }
	})
</script>

<!--note_reply_submit -->
<script type="text/javascript">
	$(document).on('click', '.note_reply_submit_button',function(event){
		event.preventDefault();
    var checked = confirm("投稿してもよろしいでしょうか？")
		var comment_id = $(this).parent().attr('id')
    if (checked == true){
  		var reply_content = $('#reply_content_' + comment_id).val()
  		$('.reply_add_container' + comment_id).slideToggle()
  		$.ajax({
  			 type: "POST",
  			 url: "{% url 'sensei_app:jltct_reply_add' %}",
  			 data: {
  				'reply_content': reply_content,
					'comment_id': comment_id,
  				'csrfmiddlewaretoken': '{{ csrf_token }}',
  		 },
  			 dataType: "json",
  			 success: function(response) {
  					$('#replies_' + comment_id).html(response['form'])
  					$('#reply_content_' + comment_id).val('')
  			},
  		});
    } else{
      return false
    }
	})
</script>

</body>
{% endblock %}
