{% extends 'sensei_app/base.html' %}
{% load static %}
{% load humanize %}
{% load markdownify %}
{% block title %}質問一覧{% endblock %}
{% block description %}
  質問一覧のページです
{% endblock %}
{% block content %}
<head>
	<link rel="stylesheet" href="{% static 'sensei_app/css/question.min.css' %}">
</head>
<body>
	{% include 'sensei_app/navbar.html' %}
	<div class="wrapper question_list_wrapper question_detail_wrapper">
		<main class="left_column">
			<div class="left_top">
				{% if question.answers == None %}
					{{question.answers}}
				{% endif %}
				<h1 class="question_title">{{question.title}}</h1>
        {% if not question.login_author %}
          {% if question.author %}
            <span class="question_author">{{ question.author }}<span class="san">さん</span></span>
          {% else %}
            <span class="question_author">名無しさん</span>
          {% endif %}
        {% else %}
          <a class="question_author login_author_link" href="{% url 'sensei_app:activities_of_user' question.login_author.pk %}"><i class="fas fa-chalkboard-teacher"></i>{{question.login_author.nickname}}<span class="san">さん</span></a>
        {% endif %}<br>
				<span class="question_created_at"><i class="far fa-clock"></i>{{ question.created_at | date:"Y/m/d f"}}</span><br>
				<a href="{% url 'sensei_app:question_category' question.category.category_slug %}" class="question_category question_category_{{ question.category.category_slug }}">{{ question.category }}</a>

			</div>
			<article class="content question_content user_content">
				{{ question.content |markdownify}}
			</article>
			<section class="answer_section">
				<div class="submit_answer">
					<button class="answer_button">回答する</button>
				</div>
				<div class="answer_form_wrapper" style="display:none;">
					{% include 'sensei_app/Question/answer_form.html' %}
				</div>
				<p class="section_head">みんなの回答({{question.answers.count}}件)</p>
				<div class="answers">
					{% include 'sensei_app/Question/comments.html' %}
				</div>

			</section><!-- answer_section end-->
		</main><!-- left column end -->
		<aside class="right_column">
			{% include 'sensei_app/Question/sidebar.html' %}
		</aside>
	</div>
	<script>
	$(document).on('click', '#answer_submit',function(event){
		event.preventDefault();
		var question_id = $(this).attr('name')
		var answer_author = $('#answer_author_id').val()
		var answer_content = $('#answer_content_id').val()
		if(answer_author == undefined || answer_author == ""){
			answer_author = '名無し'
		}
		$('.answer_form_wrapper').slideToggle()
		$.ajax({
			 type: "POST",
			 url: "{% url 'sensei_app:answer_add' %}",
			 data: {
				'question_id': question_id,
				'answer_author': answer_author,
				'answer_content': answer_content,
				'csrfmiddlewaretoken': '{{ csrf_token }}',
		 },
			 dataType: "json",
			 success: function(response) {
				 console.log('okay')
					$('.answers').html(response['form'])
					$('#answer_author_id').val('')
					$('#answer_content_id').val('')
				},

		});

			})
	$(document).on('click', '.reply_submit_button',function(event){
		event.preventDefault();
		var answer_id = $(this).attr('id')
		var reply_author = $('#reply_author_id').val()
		var reply_content = $('#reply_content_id').val()
		if(reply_author == undefined || reply_author == ""){
			reply_author = '名無し'
		}
		$('#reply_form_wrapper_' + answer_id).slideToggle()
		$.ajax({
			 type: "POST",
			 url: "{% url 'sensei_app:reply_add' %}",
			 data: {
				'answer_id': answer_id,
				'reply_author': reply_author,
				'reply_content': reply_content,
				'csrfmiddlewaretoken': '{{ csrf_token }}',
		 },
			 dataType: "json",
			 success: function(response) {
					$('.replies_container').html(response['form'])
					$('#reply_author_id').val('')
					$('#reply_content_id').val('')
				},

		});

			})
		</script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
{% endblock %}
